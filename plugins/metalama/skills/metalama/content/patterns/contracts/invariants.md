---
uid: invariants
summary: "The document explains how to check type invariants in Metalama, including adding invariants, opting out from invariant checking, and suspending enforcement of invariants, with examples provided."
level: 200
keywords: "invariant checking, Metalama, type invariants, InvariantViolationException, DoNotCheckInvariants, performance optimization, suspend invariant enforcement, ContractOptions, SuspendInvariants"
created-date: 2024-07-22
modified-date: 2025-11-30
---

# Checking type invariants

Invariants are methods that verify the consistency of the state of the current object and throw an exception if inconsistencies are found. We recommend throwing an exception of type <xref:Metalama.Patterns.Contracts.InvariantViolationException>, but the decision is entirely up to you.

## Adding invariants

To add an invariant to a class:

1. Create a `void`, non-`static`, and parameterless method in your class. This method should typically be `private`.
2. Add the <xref:Metalama.Patterns.Contracts.InvariantAttribute?text=[Invariant]> custom attribute to this method.
3. Add the validation logic to this method and throw an <xref:Metalama.Patterns.Contracts.InvariantViolationException> in case of a violation.

> [!WARNING]
> An invariant method shouldn't have any side effects other than throwing an exception in case of an invariant violation.

### Example: adding invariants

In the following example, an `Invoice` entity has two properties, `DiscountPercent` and `DiscountAmount`, that allow discounts. These two properties are additive, but their sum can't result in a negative price. The `CheckDiscounts` method enforces this condition.

[!metalama-test ~/code/Metalama.Documentation.SampleCode.Contracts/Invariants.cs]

## Opting out of invariant checking

When a type has any invariant, the implementation of all public or internal methods in this type is wrapped in a `try...finally` block, and invariants are verified from the `finally` block.

To prevent a method from being enhanced with this invariant checking logic, use the <xref:Metalama.Patterns.Contracts.DoNotCheckInvariantsAttribute?text=[DoNotCheckInvariants]> custom attribute.

Note that this won't waive the enforcement of invariants in methods _called_ by the target of the <xref:Metalama.Patterns.Contracts.DoNotCheckInvariantsAttribute?text=[DoNotCheckInvariants]> attribute. Therefore, this attribute is mainly useful to optimize performance, not to relax invariants.

## Suspending enforcement of invariants

If you have a code snippet that temporarily breaks invariants, you can suspend invariant enforcement.

First, enable the <xref:Metalama.Patterns.Contracts.ContractOptions.IsInvariantSuspensionSupported> option for this type. This option is disabled by default because it generates additional code. You can set this option from a <xref:Metalama.Framework.Fabrics.ProjectFabric> or <xref:Metalama.Framework.Fabrics.NamespaceFabric> as described in <xref:configuring-contracts>.

After enabling this feature, you can suspend invariant enforcement in two ways:

- To disable enforcement while an entire method executes, add the <xref:Metalama.Patterns.Contracts.SuspendInvariantsAttribute?text=[SuspendInvariants]> custom attribute to the method.
- To disable enforcement while a code snippet executes, wrap the snippet in a call to `using (this.SuspendInvariants())`. The `SuspendInvariants` method is generated by the <xref:Metalama.Patterns.Contracts.ContractOptions.IsInvariantSuspensionSupported> option.

### Example: suspending invariants

The following example builds upon the previous one. We've added a fabric to enable the <xref:Metalama.Patterns.Contracts.ContractOptions.IsInvariantSuspensionSupported> option. The `Invoice` class now has two new methods, `UpdateDiscounts1` and `UpdateDiscounts2`, which update `DiscountPercent` and `DiscountAmount` while suspending invariants.

[!metalama-test ~/code/Metalama.Documentation.SampleCode.Contracts/Invariants_Suspend.cs]

> [!div class="see-also"]
> <xref:contract-patterns>
> <xref:value-contracts>
> <xref:configuring-contracts>
